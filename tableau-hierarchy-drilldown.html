<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hierarchy Drill Down - Viz Extension</title>
    
    <!-- Tableau Extensions API -->
    <script src="https://cdn.online.tableau.com/extensions/1.10.0/tableau.extensions.1.10.0.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: white;
            overflow: hidden;
        }
        
        #container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        #breadcrumb {
            padding: 10px 12px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        
        .breadcrumb-item {
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .breadcrumb-link {
            color: #1f77b4;
            cursor: pointer;
            text-decoration: none;
            transition: color 0.2s;
            font-weight: 500;
        }
        
        .breadcrumb-link:hover {
            color: #0d47a1;
            text-decoration: underline;
        }
        
        .breadcrumb-separator {
            color: #adb5bd;
        }
        
        #table-wrapper {
            flex: 1;
            overflow: auto;
            background: white;
        }
        
        #data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        #data-table thead {
            background: #f1f3f5;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        #data-table th {
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            font-size: 12px;
            white-space: nowrap;
        }
        
        #data-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #f1f3f5;
            color: #212529;
            font-size: 13px;
        }
        
        #data-table tbody tr {
            transition: background-color 0.15s;
        }
        
        #data-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .drillable-cell {
            cursor: pointer;
            color: #1f77b4;
            font-weight: 500;
            position: relative;
            padding-left: 18px;
        }
        
        .drillable-cell:before {
            content: '▶';
            position: absolute;
            left: 4px;
            font-size: 9px;
            transition: transform 0.2s;
        }
        
        .drillable-cell:hover {
            color: #0d47a1;
            text-decoration: underline;
        }
        
        .drillable-cell:hover:before {
            transform: translateX(2px);
        }
        
        #status {
            padding: 20px;
            text-align: center;
            color: #6c757d;
            font-size: 14px;
        }
        
        .loading {
            color: #1f77b4;
        }
        
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 15px;
            border-radius: 4px;
            margin: 15px;
        }
        
        .number-cell {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="breadcrumb">
            <span class="breadcrumb-item">
                <span class="breadcrumb-link" id="reset-all">All Data</span>
            </span>
        </div>
        <div id="table-wrapper">
            <div id="status" class="loading">Initializing extension...</div>
        </div>
    </div>

    <script>
        'use strict';

        let dataTable;
        let hierarchyFields = [];
        let measureFields = [];
        let currentLevel = 0;
        let drillPath = [];

        // Initialize the extension as a Viz Extension
        tableau.extensions.initializeAsync({'configure': configure}).then(() => {
            console.log('Viz Extension initialized');
            loadData();
        }, (err) => {
            showError('Error initializing extension: ' + err.toString());
            console.error('Init error:', err);
        });

        function configure() {
            // Configuration dialog if needed in future
            console.log('Configure called');
        }

        async function loadData() {
            try {
                showStatus('Loading data...');
                console.log('Starting data load...');
                
                // Get the underlying data for viz extensions
                const worksheetData = await tableau.extensions.worksheetContent.worksheet.getSummaryDataAsync();
                
                console.log('Data loaded:', worksheetData);
                console.log('Columns:', worksheetData.columns);
                console.log('Rows:', worksheetData.data.length);
                
                // Store the data
                dataTable = worksheetData;
                
                // Identify hierarchies and measures
                identifyFields(worksheetData.columns);
                
                if (hierarchyFields.length === 0) {
                    showError('No dimensional fields detected. Please add dimensions to your worksheet.');
                    return;
                }
                
                console.log('Hierarchy fields:', hierarchyFields);
                console.log('Measure fields:', measureFields);
                
                // Display data at current level
                displayData(currentLevel);
                
            } catch (err) {
                showError('Error loading data: ' + err.toString());
                console.error('Load error:', err);
            }
        }

        function identifyFields(columns) {
            hierarchyFields = [];
            measureFields = [];
            
            columns.forEach(col => {
                console.log('Column:', col.fieldName, 'Type:', col.dataType);
                
                // Identify dimensions (text, dates, booleans)
                if (col.dataType === 'string' || 
                    col.dataType === 'date' || 
                    col.dataType === 'date-time' ||
                    col.dataType === 'bool') {
                    hierarchyFields.push({
                        name: col.fieldName,
                        index: col.index
                    });
                }
                // Identify measures (numbers)
                else if (col.dataType === 'int' || col.dataType === 'float') {
                    measureFields.push({
                        name: col.fieldName,
                        index: col.index
                    });
                }
            });
        }

        function displayData(level) {
            const tableWrapper = document.getElementById('table-wrapper');
            
            if (!hierarchyFields || hierarchyFields.length === 0) {
                showError('No hierarchy fields available');
                return;
            }
            
            // Filter data based on drill path
            let filteredData = dataTable.data;
            if (drillPath.length > 0) {
                filteredData = dataTable.data.filter(row => {
                    return drillPath.every((pathItem, idx) => {
                        const fieldIndex = hierarchyFields[idx].index;
                        const cellValue = row[fieldIndex].value;
                        return cellValue === pathItem.value;
                    });
                });
            }
            
            // Aggregate data by current level
            const aggregatedData = aggregateByLevel(filteredData, level);
            
            // Create table
            let html = '<table id="data-table"><thead><tr>';
            
            // Add hierarchy column header
            if (level < hierarchyFields.length) {
                html += `<th>${hierarchyFields[level].name}</th>`;
            }
            
            // Add measure headers
            measureFields.forEach(measure => {
                html += `<th class="number-cell">${measure.name}</th>`;
            });
            
            html += '</tr></thead><tbody>';
            
            // Add data rows
            aggregatedData.forEach(row => {
                html += '<tr>';
                
                // Add dimension value (drillable if not at deepest level)
                const isDrillable = level < hierarchyFields.length - 1;
                const cellClass = isDrillable ? 'drillable-cell' : '';
                const value = row.dimension;
                
                html += `<td class="${cellClass}" data-value="${escapeHtml(value)}" data-level="${level}">${escapeHtml(value)}</td>`;
                
                // Add measures
                measureFields.forEach(measure => {
                    const measureValue = row.measures[measure.name] || 0;
                    html += `<td class="number-cell">${formatNumber(measureValue)}</td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            
            tableWrapper.innerHTML = html;
            
            // Add click handlers to drillable cells
            document.querySelectorAll('.drillable-cell').forEach(cell => {
                cell.addEventListener('click', handleDrillDown);
            });
            
            updateBreadcrumb();
        }

        function aggregateByLevel(data, level) {
            if (level >= hierarchyFields.length) return [];
            
            const dimensionField = hierarchyFields[level];
            const aggregated = {};
            
            data.forEach(row => {
                const dimValue = row[dimensionField.index].value;
                const dimKey = String(dimValue);
                
                if (!aggregated[dimKey]) {
                    aggregated[dimKey] = {
                        dimension: dimValue,
                        measures: {}
                    };
                    
                    measureFields.forEach(measure => {
                        aggregated[dimKey].measures[measure.name] = 0;
                    });
                }
                
                // Sum measures
                measureFields.forEach(measure => {
                    const value = parseFloat(row[measure.index].value) || 0;
                    aggregated[dimKey].measures[measure.name] += value;
                });
            });
            
            return Object.values(aggregated).sort((a, b) => {
                const aVal = String(a.dimension);
                const bVal = String(b.dimension);
                return aVal.localeCompare(bVal);
            });
        }

        function handleDrillDown(event) {
            const cell = event.currentTarget;
            const value = cell.dataset.value;
            const level = parseInt(cell.dataset.level);
            
            console.log('Drilling down:', value, 'at level', level);
            
            // Add to drill path
            drillPath.push({
                field: hierarchyFields[level].name,
                value: value,
                level: level
            });
            
            currentLevel = level + 1;
            
            // Redisplay data
            displayData(currentLevel);
        }

        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            let html = '<span class="breadcrumb-item"><span class="breadcrumb-link" id="reset-all">All Data</span></span>';
            
            drillPath.forEach((item, idx) => {
                html += '<span class="breadcrumb-separator">›</span>';
                html += `<span class="breadcrumb-item">`;
                html += `<span class="breadcrumb-link" data-level="${idx}">${escapeHtml(String(item.value))}</span>`;
                html += `</span>`;
            });
            
            breadcrumb.innerHTML = html;
            
            // Add click handlers
            document.getElementById('reset-all').addEventListener('click', resetDrill);
            
            document.querySelectorAll('.breadcrumb-link[data-level]').forEach(link => {
                link.addEventListener('click', (e) => {
                    const level = parseInt(e.target.dataset.level);
                    drillToLevel(level);
                });
            });
        }

        function resetDrill() {
            console.log('Resetting drill');
            drillPath = [];
            currentLevel = 0;
            displayData(currentLevel);
        }

        function drillToLevel(level) {
            console.log('Drilling to level', level);
            drillPath = drillPath.slice(0, level + 1);
            currentLevel = level + 1;
            displayData(currentLevel);
        }

        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            if (Number.isInteger(num)) return num.toLocaleString();
            return num.toLocaleString(undefined, { 
                minimumFractionDigits: 0,
                maximumFractionDigits: 2 
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showStatus(message) {
            const tableWrapper = document.getElementById('table-wrapper');
            tableWrapper.innerHTML = `<div id="status" class="loading">${message}</div>`;
        }

        function showError(message) {
            const tableWrapper = document.getElementById('table-wrapper');
            tableWrapper.innerHTML = `<div class="error">${message}</div>`;
            console.error(message);
        }
    </script>
</body>
</html>
