<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configure Hierarchy Drill Down</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 16px; margin: 0; }
    label { display: block; font-weight: 600; margin-top: 12px; }
    select { width: 100%; padding: 8px; margin-top: 4px; }
    p { color: #666; font-size: 12px; margin-top: 4px; }
    button { margin-top: 16px; padding: 8px 16px; cursor: pointer; background: #0066a1; color: #fff; border: none; border-radius: 4px; }
    button:hover { background: #005080; }
  </style>
</head>
<body>
  <label for="worksheet">Worksheet</label>
  <select id="worksheet">
    <option value="">— Select worksheet —</option>
  </select>
  <p>Choose a worksheet that contains your hierarchy dimensions (e.g. Country, State, City on Rows).</p>

  <label for="columns">Hierarchy columns (optional)</label>
  <select id="columns" multiple size="6">
  </select>
  <p>Select columns in order from top to bottom. Leave empty to use first 5 dimension columns.</p>

  <button id="save">Save</button>

  <script src="https://extension.tableau.com/javascripts/extensions-api/tableau.extensions.1.latest.min.js"></script>
  <script>
    const WORKSHEET_KEY = 'worksheet';
    const COLUMNS_KEY = 'columns';

    tableau.extensions.initializeDialogAsync().then(() => {
      const worksheets = tableau.extensions.dashboardContent.dashboard.worksheets;
      const wsSelect = document.getElementById('worksheet');
      worksheets.forEach(ws => {
        const opt = document.createElement('option');
        opt.value = ws.name;
        opt.textContent = ws.name;
        wsSelect.appendChild(opt);
      });

      const savedWs = tableau.extensions.settings.get(WORKSHEET_KEY);
      if (savedWs) wsSelect.value = savedWs;

      wsSelect.addEventListener('change', loadColumns);
      loadColumns();

      document.getElementById('save').addEventListener('click', save);
    });

    async function loadColumns() {
      const worksheetName = document.getElementById('worksheet').value;
      const colSelect = document.getElementById('columns');
      colSelect.innerHTML = '';

      if (!worksheetName) return;

      try {
        const ws = tableau.extensions.dashboardContent.dashboard.worksheets.find(w => w.name === worksheetName);
        if (!ws) return;

        let dataTable;
        if (ws.getSummaryDataReaderAsync) {
          const reader = await ws.getSummaryDataReaderAsync();
          try {
            dataTable = await reader.getAllPagesAsync();
          } finally {
            await reader.releaseAsync();
          }
        } else {
          dataTable = await ws.getSummaryDataAsync();
        }

        const dims = dataTable.columns.filter(c => c.dataType === 'string' || c.dataType === 'integer');
        dims.forEach(col => {
          const opt = document.createElement('option');
          opt.value = col.fieldName;
          opt.textContent = col.fieldName;
          colSelect.appendChild(opt);
        });

        const savedCols = tableau.extensions.settings.get(COLUMNS_KEY);
        if (savedCols) {
          const arr = JSON.parse(savedCols);
          for (let i = 0; i < colSelect.options.length; i++) {
            colSelect.options[i].selected = arr.includes(colSelect.options[i].value);
          }
        }
      } catch (e) {
        colSelect.innerHTML = '<option disabled>Load worksheet first</option>';
      }
    }

    function save() {
      const worksheet = document.getElementById('worksheet').value;
      const selected = Array.from(document.getElementById('columns').selectedOptions).map(o => o.value);
      tableau.extensions.settings.set(WORKSHEET_KEY, worksheet);
      tableau.extensions.settings.set(COLUMNS_KEY, JSON.stringify(selected));
      tableau.extensions.settings.saveAsync().then(() => {
        tableau.extensions.ui.closeDialog('');
      });
    }
  </script>
</body>
</html>
